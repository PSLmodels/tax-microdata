---
output: html_document
editor_options: 
 chunk_output_type: console
---

# Get Congressional District files for 2021

## About the data

The following comments are extracted from the IRS SOI data documentation (21incddocguide.docx). All text in this section is a direct quote from the documentation.

### Time period

The Statistics of Income (SOI) Division’s Congressional district data is tabulated using individual income tax returns (Forms 1040) filed with the Internal Revenue Service (IRS) during the 12-month period, January 1, 2022 to December 31, 2022. While the bulk of returns filed during this 12-month period are primarily for Tax Year 2021, the IRS received a limited number of returns for tax years before 2021. These prior-year returns are used as a proxy for returns that are typically filed beyond the 12-month period and have been included within the congressional district data.


### Population Definitions and Tax Return Addresses

-   Congressional data are based on the population of individual income tax returns processed by the IRS during the 2022 calendar year.

-   Returns filed for the purpose of receiving an Economic Impact Payment, due to COVID-19, were excluded from the data.

-   State totals within the Congressional data may not be comparable to State totals published elsewhere by SOI because of disclosure protection procedures or the exclusion of returns that did not match based on the ZIP code. See footnote for complete State totals. [2] 

-   Data do not represent the full U.S. population because many individuals are not required to file an individual income tax return.

-   The address shown on the tax return may differ from the taxpayer’s actual residence.

-   Congressional districts were based on the ZIP code shown on the return.

-   Tax returns filed without a ZIP code and returns filed with a ZIP code that did not match the State code shown on the return were excluded.

-   Tax returns filed using Army Post Office (APO) and Fleet Post Office addresses, foreign addresses, and addresses in Puerto Rico, Guam, Virgin Islands, American Samoa, Marshall Islands, Northern Marianas, and Palau were excluded.


### Congressional District and ZIP Code Matching Procedures

SOI uses a commercial file to match ZIP codes to congressional districts. Congressional districts cover the 435 congressional districts in the 50 states and the District of Columbia. District boundaries are based on the 117th Congress.

The matching process first utilizes the 9-digit ZIP code, if present on the return, to determine the proper congressional district for that return. Nearly 97 percent of the returns match on the 9-digit ZIP code. When the 9-digit ZIP code is not available, the matching process uses the 5-digit ZIP code to determine the proper congressional district. Returns that do not match on ZIP code, or where a ZIP code is not present, are excluded from the data. 

Eight states (AK, DC, DE, MT, ND, SD, VT, and WY) have only one congressional district, therefore the matching procedures are not performed on these states. Returns with only one congressional district represent 2 percent of the total number of returns.

### Disclosure Protection Procedures

SOI did not attempt to correct any ZIP codes listed on the tax returns; however, it did take the following precautions to avoid disclosing information about specific taxpayers:

-   Income and tax items with less than 20 returns for a particular AGI class were combined with another AGI class within the same congressional district.  Collapsed AGI classes are identified with a double asterisk (**) in the Excel files.

-   Income and tax items with less than 20 returns for a congressional district were excluded.

-   If an income or tax item from one return constitutes more than a specified percentage of the total of any particular cell, the specific data item for that return is excluded from that cell.  For example, if the amount for wages from one return represents 75 percent of the value of the total for that cell, the data item will be suppressed. The actual threshold percentage used cannot be released.   

## Comments on the data

... Determining which records are CD records...

## Setup

```{r}
#| label: load-packages

library(DT)
library(fs)
library(readxl)
library(stringr)
library(tidyverse)
# includes: dplyr, forcats, ggplot2, lubridate, purrr, stringr, tibble, tidyr

tprint <- 75  # default tibble print
options(tibble.print_max = tprint, tibble.print_min = tprint) # show up to tprint rows

```

```{r}
#| label: constants

CDZIPURL <- "https://www.irs.gov/pub/irs-soi/congressional2021.zip"
CDDOCURL <- "https://www.irs.gov/pub/irs-soi/21incddocguide.docx"

CDDIR <- here::here("cds")
CDRAW <- fs::path(CDDIR, "raw_data")

CDDOCEXTRACT <- "cd_documentation_extracted_from_21incddocguide.docx.xlsx"

```

## Download CD data and documentation if not already downloaded

-   [SOI Congressional Districts landing page](https://www.irs.gov/statistics/soi-tax-stats-data-by-congressional-district)

    -   [2021 folder](https://www.irs.gov/statistics/soi-tax-stats-data-by-congressional-district-2021)

NOTE: To download data, change eval: to true in the header of the following chunk. Otherwise, this program assumes data already have been downloaded.

```{r}
#| label: downloads
#| eval: false

# data
fname <- fs::path_file(CDZIPURL)
download.file(url = CDZIPURL, destfile = fs::path(CDRAW, fname), mode = "wb")

# documentation
fname <- fs::path_file(CDDOCURL)
download.file(url = CDDOCURL, destfile = fs::path(CDRAW, fname), mode = "wb")

```

## Parse and show Congressional District data documentation

```{r}
#| label: parse-doc
#| output: false

doc1 <- read_excel(fs::path(CDRAW, CDDOCEXTRACT), sheet = "cleaned", range = "A2:D169")

# clean the reference field so that we can show line breaks in datatable
doc2 <- doc1 |> 
  mutate(reference = str_replace_all(reference,
                                 coll("\r\n"),
                                 "<br>"
                                 ))

```

Show documentation table for variables in the Congressional District csv data.

```{r}
#| label: show-doc

doc2 |> 
  mutate(row = row_number()) |> 
  relocate(row) |> 
  DT::datatable(rownames = FALSE,
                options = list(order = list(0, "asc"), 
                               autoWidth = TRUE), 
                escape = FALSE)

```

## Parse the Congressional District data

Clean the CD data and save as an rds file.

```{r}
#| label: parse-cddata
#| eval: false


# read the csv file from the zip archive that contains it
zpath <-  fs::path(CDRAW, fs::path_file(CDZIPURL))
con <- unz(zpath, "21incd.csv")
data <- read_csv(con)
close(con)

# data checks

count(data, STATE) # US, DC, and 50 states
count(data, CONG_DISTRICT) # max is 53
data |> 
  filter(STATE != "US") |> 
  select(STATE, CONG_DISTRICT) |> 
  distinct() |> 
  summarise(n=n(), .by=STATE) |> 
  janitor::adorn_totals() # how can we have 479 CDs??
  
check <- data |> 
  filter(STATE != "US") |> 
  select(STATE, CONG_DISTRICT) |> 
  distinct() |> 
  mutate(n=n(), .by=STATE)

nbystate <- check |> 
  select(STATE, n) |> 
  distinct()

data |> 
  filter(STATE != "US", agi_stub==0) |> 
  select(STATE, CONG_DISTRICT, N1) |> 
  arrange(desc(N1))

temp <- data |>
  select(1:5) |> 
  filter(STATE != "US", agi_stub==0) |> 
  mutate(ndists=n(), .by=STATE) |> 
  mutate(keep=(ndists == 1) | (CONG_DISTRICT != "00")) |> 
  filter(keep)


```


```{r}
#| label: clean-cddata
#| eval: false

dlong1 <- data |> 
  rename_with(toupper) |> 
  pivot_longer(cols = -c(1:4)) |> 
  left_join()



# create a cleaned, long, data frame
idvars <- c("stfips", "stabbr", "cd", "agistub")
dlong <- data |> 
  rename_with(tolower) |> 
  rename(stfips = "statefips",
         stabbr = "state",
         cd = "cong_district",
         agistub = "agi_stub") |> 
  pivot_longer(cols = -all_of(idvars))

```


